{% extends "layout_admin.html" %}
{% from "macros/form.html" import input, textarea %}
{% block title %} 게시자료 수정 {% endblock %}

{% block main_section %}

<div class="content">
    <div class="container-fluid">
		<div class="col-md-10">
			<div class="card">
				<form id="board_update" name="board_update" method="POST" enctype="multipart/form-data" action="{{ url_for('boards.admin_board_update_post') }}" class="form-horizontal">
					<div class="card-header card-header-icon" data-background-color="rose">
                        <i class="material-icons">assignment</i>
                    </div>
					<div class="card-content">
                        <h4 class="card-title">{{ res.BoardKindID | board_kind_name() }} 수정 ({{res.ProductKindID | product_kind_name if res.ProductKindID | product_kind_name else '공통'}})</h4>

						<div class="row">
							<label class="col-sm-2 label-on-left">제목</label>
                        	<div class="col-sm-10">
								<div class="form-group label-floating is-empty">
									<label class="control-label"></label>
									{{ input('hidden', 'board_id', res.BoardID, opt='required') }}
									{{ input('hidden', 'board_kind_id', res.BoardKindID, opt='required') }}
									{{ input('hidden', 'product_kind_id', res.ProductKindID, opt='required') }}
									{{ input('text', 'title', res.Title, opt='required') }}
									<span class="help-block">제목을 입력해 주세요.</span>
								</div>
                            </div>
						</div>
						<div class="row">
							<label class="col-sm-2 label-on-left">내용</label>
                        	<div class="col-sm-10">
								<div class="form-group label-floating is-empty">
									<label class="control-label"></label>
									{{ textarea(name='comments', value=res.Comments, row='5', class='trumbo',  placeholder='내용을 입력하세요.') }}
								</div>
                            </div>
						</div>
						<div class="row">
							<label class="col-sm-2 label-on-left">첨부파일</label>
                        	<div class="col-sm-10">
								<div class="form-group label-floating is-empty">
									<label class="control-label"></label>
									{{ input('file', 'upload_file_path', upload_file_path, opt='multiple', onchange='checkFiles(this)') }}
									<span class="help-block">허용된 파일: "jpg", "png", "txt", "doc", "docx", "xls", "xlsx", "pdf", "ppt", "pptx", "mp3", "stk"</span>
								</div>
                        	</div>
						</div>

                    	<br />
    					<div class="row">
							<label class="col-sm-2 label-on-left"></label>
                            <div class="col-sm-10">
 								<div class="table-responsive">
									<table class="table table-striped">
										<tbody>
											{% for file in file_list %}
												<tr id="row_{{file.BoardFileID}}">
													<td class="text-left" style="padding-left:0px; padding-top:3px; padding-bottom:3px; border-top:0px">
														<a href="{{ url_for('file_download', file_path=file.UploadFilePath, file_name=file.UploadFileName, download_yn=1) }}">{{file.UploadFileName}}</a> &nbsp;&nbsp;
														<a href="javascript:deleteFile({{file.BoardFileID}});" class="text-danger">x</a>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
                            </div>
                        </div>

						<br />
                    	<div class="row">
							<label class="col-sm-2 label-on-left"></label>
							<div class="col-md-10">
								<div class="form-group form-button">
									<button type="button" onclick="javascript:history.back()" class="btn btn-fill btn-github">뒤로가기</button>
 	                            	<button type="submit" class="btn btn-fill btn-facebook">수정하기</button>
 	                            	<button type="button" onclick="deleteContents({{res.BoardID}});" class="btn btn-fill btn-danger">삭제하기</button>
	                        	</div>
	                    	</div>
						</div>
                    </div>
				</form>
			</div>
		</div>
    </div>
</div>

<script>
	var deleteContents = function (board_id) {
        swal({
            title: '삭제',
            text: "등록된 게시글을 정말로 삭제하시겠습니까?",
            type: 'warning',
            showCancelButton: true,
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger',
            confirmButtonText: 'Yes, delete it!',
            buttonsStyling: false
        }).then(function () {
            $.ajax({
                type: "POST",
                url: "{{ url_for('boards.admin_board_delete') }}",
                data: { board_id: board_id },
                success: function (result) {
                    window.location.href = "/boards/admin_board_list?board_kind_id={{res.BoardKindID}}&product_kind_id={{res.ProductKindID}}";
                }
            });
        }).catch(swal.noop);
    }

    var deleteFile = function (board_file_id) {
        swal({
            title: '삭제',
            text: "선택한 파일을 정말로 삭제하시겠습니까?",
            type: 'warning',
            showCancelButton: true,
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger',
            confirmButtonText: 'Yes, delete it!',
            buttonsStyling: false
        }).then(function () {
            $.ajax({
                type: "POST",
                url: "{{ url_for('boards.admin_board_file_delete') }}",
                data: { board_file_id: board_file_id },
                success: function (result) {
                    $("#row_" + board_file_id).remove();
                }
            })
        }).catch(swal.noop);
    }

    function checkFiles(input) {
		const files = input.files;
		const maxSizeInBytes = 1024 * 1024 * 50;
        const allowedExtensions = ["jpg", "jpeg", "png", "JPG", "JPEG", "PNG", "txt", "doc", "docx", "xls", "xlsx", "pdf", "ppt", "pptx", "mp3", "stk"];

		for (let i = 0; i < files.length; i++) {
			const file = files[i];

			// 파일 크기 체크
			if (file.size > maxSizeInBytes) {
 	            site.showNotification('top','center', '최대 크기(50메가)를 초과하는 파일이 있습니다.', 'danger')
				input.value = ''; // 파일 선택을 취소합니다.
				input.type = 'file'; // 파일을 리셋합니다.
				return;
			}

			// 파일 확장명 체크
			const fileNameParts = file.name.split('.');
			const fileExtension = fileNameParts[fileNameParts.length - 1].toLowerCase();
			if (!allowedExtensions.includes(fileExtension)) {
 	            site.showNotification('top','center', '허용되지 않은 확장명이 포함된 파일이 있습니다.', 'warning')
				input.value = ''; // 파일 선택을 취소합니다.
				input.type = 'file'; // 파일을 리셋합니다.
				return;
			}
		}
	}

	var form_submit = function() {
		document.board_update.submit();
  	};
</script>

{% endblock %}			 

			