{% extends "layout_admin.html" %}
{% from "macros/form.html" import input %}
{% from "macros/modal.html" import hidden_modal %}

{% block title %} 음원모음 관리 {% endblock %}
{% block main_section %}

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header card-header-icon" data-background-color="rose">
                        <i class="material-icons">{{route_kind_id | route_kind_info('icon')}}</i>
                    </div>
                    <div class="card-content">
                        <h4 class="card-title">{{route_kind_id | route_kind_info('name')}} ({{group_name}})
                        </h4>
                        <p class="card-category">
                            첨부파일/음원링크로 서비스 가능합니다. 첨부파일의 업로드는 MP3 파일로 <strong>30메가</strong>까지 가능합니다.<br />
                            눈동자 버튼의 첫번째는 <span class="text-success"><strong>회원(녹색)</strong></span>의 사용여부, 두번째는 <span class="text-info"><strong>교사(파란색)</strong></span>의 사용여부입니다. <br />

                        </p>
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-group">
                                    <select id="attach_file_yn" class="form-control" >
                                        <option value="1">첨부파일</option>
                                        <option value="0">링크연결</option>
                                    </select>
                                </label>
                                <label class="form-group">
                                    {{ input('hidden', 'content_group_id', content_group_id, opt='required') }}
                                    {{ input('text', 'title', opt='required autofocus', placeholder='타이틀 등록') }}
                                </label>
                                <button class="btn btn-primary btn-round btn-fab btn-fab-mini" onclick="titleInsert();" >
                                    <i class="material-icons">add</i>
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="sortable-table" class="table table-striped">
                                <thead class="text-primary">
                              		<tr>
										<th class="text-center" colspan="2" width="10%">ID</th>
										<th class="text-center" colspan="3" width="50%">타이틀</th>
										<th class="text-center" width="12%">작성자</th>
										<th class="text-center" width="8%">옵션</th>
										<th class="text-center" width="20%">파일명</th>
									</tr>
                                </thead>
                                <tbody>
                                    {% for res in res_list %}
										<tr id="row_{{res.UpperContentMusicID}}" data-id="{{res.UpperContentMusicID}}">
                                            <td class="text-left handle" width="3%">
                                                <i class="material-icons">swap_vert</i>
                                            </td>
                                            <td class="text-center" width="7%">{{res.UpperContentMusicID}}</td>
											<td class="text-left" width="10%">
                                                <span id="hidden_attach_file_{{res.UpperContentMusicID}}" style="display: none;">{{res.AttachFileYn | int}}</span>
                                                <label class="form-group">
                                                    <select id="attach_file_{{res.UpperContentMusicID}}" class="form-control">
                                                        <option value="0" {{'selected' if not res.AttachFileYn}}>랑크연결</option>
                                                        <option value="1" {{'selected' if res.AttachFileYn}}>첨부파일</option>
                                                    </select>
                                                </label>
                                            </td>
											<td class="text-left" width="22%">
                                                <span id="hidden_title_{{res.UpperContentMusicID}}" style="display: none;">{{res.Title}}</span>
                                                {{ input('text', 'title_'+(res.UpperContentMusicID | string), res.Title) }}
											</td>
										    <td class="text-center td-actions" width="18%">
                                                <button type="button" onclick="contentUpdate({{res.UpperContentMusicID}});" class="btn btn-facebook btn-round">
                                                    <i class="material-icons">edit</i>
                                                </button>
                                                <button id="play_{{res.UpperContentMusicID}}" type="button" class="btn {{'btn-reddit' if res.AttachFileYn else 'btn-warning'}} btn-round" onclick="playSingle({{res.UpperContentMusicID}})">
                                                    <i class="material-icons">play_arrow</i>
                                                </button>
                                                &nbsp;&nbsp;
                                                <button id="display_{{res.UpperContentMusicID}}" type="button" onclick="displayUpdate({{res.UpperContentMusicID}}, {{0 if res.UseYn else 1}}, 0);" class="btn btn-round {{'btn-success' if res.UseYn}}">
                                                    <i class="material-icons">visibility</i>
                                                </button>
                                                <button id="display_manager_{{res.UpperContentMusicID}}" type="button" onclick="displayUpdate({{res.UpperContentMusicID}}, {{0 if res.ManagerUseYn else 1}}, 1);" class="btn btn-round {{'btn-info' if res.ManagerUseYn}}">
                                                    <i class="material-icons">visibility</i>
                                                </button>
                                                <button type="button" onclick="contentDelete({{res.UpperContentMusicID}});" class="btn btn-round btn-github">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                            </td>
											<td class="text-center" width="12%">{{res.MemberName}}</td>
                                            <td class="text-center td-actions" width="8%">
                                                <a href="{{ url_for('admin_content_upper_music_update', route_kind_id=route_kind_id, product_kind_id=product_kind_id, content_group_id=content_group_id, upper_content_music_id=res.UpperContentMusicID) }}" class="btn {{'btn-rose' if res.MusicLinkYn}}">
                                                    <i class="material-icons">queue_music</i>
                                                </a>
                                                <button id="img_{{res.UpperContentMusicID}}" type="button" onclick="image_click({{res.UpperContentMusicID}})" class="btn {{'btn-warning' if res.UploadFilePath}}">
                                                    <i class="material-icons">inventory_2</i>
                                                </button>
                                                <form id="frm_{{res.UpperContentMusicID}}" method="POST" enctype="multipart/form-data">
                                                    <input id="file_{{res.UpperContentMusicID}}" type="file" onchange="image_upload({{res.UpperContentMusicID}})" style="opacity:0; width: 0; height: 0;">
                                                </form>
                                            </td>
											<td class="text-center" width="20%">
                                                <span id="upload_{{res.UpperContentMusicID}}">
                                                    {% if res.UploadFileName != None %}
                                                          <a href="{{ url_for('file_download', file_path=res.UploadFilePath, file_name=res.UploadFileName, download_yn=1) }}">{{res.UploadFileName}}</a>
                                                          <a href="javascript:deleteFile({{res.UpperContentMusicID}});" class="text-danger">x</a>
                                                    {% endif %}
                                                </span>
                                            </td>
                                        </tr>
									{% else %}
										<tr>
											<td colspan="10" class="text-center">
												<h4>데이터가 존재하지 않습니다.</h4>
											</td>
										</tr>
									{% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-fill btn-github" onclick="javascript:history.back()">뒤로가기</button>
                        <button type="button" class="btn btn-fill btn-success" onclick="changeSorts()">순서저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% call hidden_modal('audioModal') %}
	<div class="audio-player">
		<h5><strong><span id="audioTitle">음원을 선택해주세요.</span></strong></h5>
        <audio id="myAudio">
            <source id="audioSource" src="" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <div class="progress-bar" onclick="setProgress(event)">
            <div class="progress"></div>
        </div>
        <div class="time">
            <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
        </div>
        <div class="audio-controls">
            <button onclick="controlAudio('prev')"><<</button>
            <button onclick="controlAudio('play')">Play</button>
            <button onclick="controlAudio('pause')">Pause</button>
            <button onclick="controlAudio('restart')">Restart</button>
<!--												<button onclick="controlAudio('mute')">Mute</button>-->
            <button onclick="controlAudio('next')">>></button>
        </div>
    </div>
{% endcall %}








<script>
    document.addEventListener('DOMContentLoaded', function() {
        //	 $('#sortable-table tbody').sortable();
        $('#sortable-table tbody').sortable({
            handle: '.handle'  // 'handle' 클래스를 드래그 핸들로 지정
        });
    });

    function changeSorts() {
        var ids = [];
        $('#sortable-table tbody tr').each(function() {
          ids.push($(this).data('id'));
        });

        $.ajax({
            type: "POST",
            contentType: 'application/json',
            data: JSON.stringify({ upper_content_music_ids: ids }),
            url: "/products/admin_content_upper_sort_music_update",
            success: function (result) {
                site.showNotification('top','center', '순서를 변경하였습니다.', 'info')
            }
        })
    }

    function titleInsert() {
        content_group_id = document.getElementById("content_group_id").value;
        attach_file_yn = document.getElementById("attach_file_yn").value;
        title = document.getElementById("title").value;

        if (title == ""){
            site.showNotification('top','center', '타이틀을 넣어주세요.', 'info')
        } else {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_upper_music_title_insert",
                data: { content_group_id: content_group_id, attach_file_yn: attach_file_yn, title: title },
                success: function (result) {
                    window.location.reload();
                }
            });
        }
    }

    function contentUpdate(upper_content_music_id) {
        title = document.getElementById("title_" + upper_content_music_id).value;
        hidden_title = document.getElementById("hidden_title_" + upper_content_music_id).innerText;
        attach_file_yn = document.getElementById("attach_file_" + upper_content_music_id).value;
        hidden_attach_file_yn = document.getElementById("hidden_attach_file_" + upper_content_music_id).innerText;

        if (title == hidden_title && attach_file_yn == hidden_attach_file_yn) {
            site.showNotification('top','center', '컨텐츠 정보를 변경해야만 수정이 가능합니다.', 'danger')
        } else {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_upper_music_title_update",
                data: { upper_content_music_id: upper_content_music_id, title: title, attach_file_yn: attach_file_yn },
                success: function (res) {
                    document.getElementById("hidden_title_" + upper_content_music_id).innerText = title;
                    document.getElementById("hidden_attach_file_" + upper_content_music_id).innerText = attach_file_yn;
                    if (attach_file_yn==1){
                        document.getElementById("play_" + upper_content_music_id).className = 'btn btn-reddit btn-round js-modal-vimeo-showcase';
                    } else {
                        document.getElementById("play_" + upper_content_music_id).className = 'btn btn-warning btn-round js-modal-vimeo';
                    }
                    site.showNotification('top','center', '정상적으로 수정하였습니다.', 'info')
                }
            });
        }
    }

    function displayUpdate(upper_content_music_id, display_yn, manager_yn) {
        $.ajax({
            type: "POST",
            url: "/products/admin_content_upper_music_display_update",
            data: { upper_content_music_id: upper_content_music_id, display_yn: display_yn, manager_yn: manager_yn },
            success: function (result) {
                btnElement = document.getElementById("display_" + upper_content_music_id);
                btnManagerElement = document.getElementById("display_manager_" + upper_content_music_id);

                if (manager_yn == 1) {
                    if (display_yn === 1) {
                        btnManagerElement.className = 'btn btn-round btn-info';
                        btnManagerElement.setAttribute('onclick', 'displayUpdate(' + upper_content_music_id + ', 0, 1)');
                    } else {
                        btnManagerElement.className = 'btn btn-round';
                        btnManagerElement.setAttribute('onclick', 'displayUpdate(' + upper_content_music_id + ', 1, 1)');
                    }
                } else {
                    if (display_yn === 1) {
                        btnElement.className = 'btn btn-round btn-success';
                        btnElement.setAttribute('onclick', 'displayUpdate(' + upper_content_music_id + ', 0, 0)');
                    } else {
                        btnElement.className = 'btn btn-round';
                        btnElement.setAttribute('onclick', 'displayUpdate(' + upper_content_music_id + ', 1, 0)');
                    }
                }
            }
        });
    }

   function contentDelete(upper_content_music_id) {
        swal({
            title: '삭제',
            text: upper_content_music_id+"번 자료를 정말로 삭제하시겠습니까?",
            type: 'warning',
            showCancelButton: true,
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger',
            confirmButtonText: 'Yes, delete it!',
            buttonsStyling: false
        }).then(function () {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_upper_music_delete",
                data: { upper_content_music_id: upper_content_music_id },
                success: function (result) {
                    swal({
                        title: '삭제완료!',
                        text: '정상적으로 삭제하였습니다.',
                        type: 'success',
                        confirmButtonClass: "btn btn-success",
                        buttonsStyling: false
                    }),
                        $("#row_" + upper_content_music_id).remove();
                }
            })
        }).catch(swal.noop);
    }

    function image_click(upper_content_music_id) {
        $('#file_'+upper_content_music_id).click();
    }

    function image_upload(upper_content_music_id) {

        var form = $('#frm_' + upper_content_music_id)[0],
            formData = new FormData(form),
            file = $('#file_' + upper_content_music_id)[0].files[0];

        const maxSizeInBytes = 1024 * 1024 * 30;
        const allowedExtensions = ["mp3"];
        const fileNameParts = file.name.split('.');
        const fileExtension = fileNameParts[fileNameParts.length - 1].toLowerCase();

        if (file.size > maxSizeInBytes) {
            site.showNotification('top','center', '파일 크기가 허용된 최대 크기(30메가)를 초과했습니다.', 'danger')
            file = ''; // 파일 선택을 취소합니다.
            return;
        }
        else if (!allowedExtensions.includes(fileExtension)) {
            site.showNotification('top','center', '허용된 파일 확장명이 아닙니다.', 'warning')
            file = ''; // 파일 선택을 취소합니다.
            return;
        }
        else {
            formData.append("image_file", file);
            formData.append("upper_content_music_id", upper_content_music_id);

            $.ajax({
                url: '/products/admin_content_music_file_upload'
                , processData: false
                , contentType: false
                , data: formData
                , type: 'POST'
                , success: function (res) {
                    if (res && res.file_name)
                        window.location.reload();
                    }
            });
        }
    }

    var deleteFile = function (upper_content_music_id) {
        swal({
            title: '삭제',
            text: "선택한 파일을 정말로 삭제하시겠습니까?",
            type: 'warning',
            showCancelButton: true,
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger',
            confirmButtonText: 'Yes, delete it!',
            buttonsStyling: false
        }).then(function () {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_upper_music_file_delete",
                data: { upper_content_music_id: upper_content_music_id },
                success: function (result) {
                    window.location.reload();
                }
            })
        }).catch(swal.noop);
    }


    const audio = document.getElementById('myAudio');
    const audioTitle = document.getElementById('audioTitle');
    const audioSource = document.getElementById('audioSource');
    let currentTrack = 0;
    let tracks = [];

    function loadTrack(index) {
        audioSource.src = tracks[index].src;
        audioTitle.innerText = tracks[index].title;
        audio.load();
    }

    const progressBar = document.querySelector('.progress-bar');
    const progress = document.querySelector('.progress');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');

    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', () => {
        durationEl.textContent = formatTime(audio.duration);
    });

    function updateProgress() {
        const { currentTime, duration } = audio;
        const progressPercent = (currentTime / duration) * 100;
        progress.style.width = `${progressPercent}%`;
        currentTimeEl.textContent = formatTime(currentTime);
    }

    function setProgress(e) {
        const width = progressBar.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        audio.currentTime = (clickX / width) * duration;
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function controlAudio(action) {
        switch(action) {
            case 'prev':
                currentTrack = (currentTrack > 0) ? currentTrack - 1 : tracks.length - 1;
                loadTrack(currentTrack);
                audio.play();
                break;
            case 'next':
                currentTrack = (currentTrack < tracks.length - 1) ? currentTrack + 1 : 0;
                loadTrack(currentTrack);
                audio.play();
                break;
            case 'play':
                audio.play();
                break;
            case 'pause':
                audio.pause();
                break;
            case 'restart':
                audio.currentTime = 0;
                audio.play();
                break;
            case 'mute':
                audio.muted = !audio.muted;
                break;
        }
    }

    function playSingle(trackId, loop_yn = false) {
        $("#audioModal").modal("show");
        initializeMusicPlayer([trackId], loop_yn);
    }

    function initializeMusicPlayer(musicIds, loop_yn) {
        tracks = musicIds.map((id, index) => {
            const title = document.getElementById('music_title_'+id).value;
            const src = document.getElementById('music_url_'+id).value;
            return { title: title, src: src };
        });
        currentTrack = 0;
        loadTrack(currentTrack);  // 첫 번째 트랙 로드
        loop = loop_yn;
        audio.play();
    }

    // 트랙 끝날 때 다음 트랙으로 자동 이동 (마지막 트랙에서는 멈추거나 루프 설정에 따라 반복 재생)
    audio.addEventListener('ended', function() {
        if (currentTrack < tracks.length - 1) {
            currentTrack++;
            loadTrack(currentTrack);
            audio.play();
        } else if (loop) {
            currentTrack = 0;
            loadTrack(currentTrack);
            audio.play();
        }
    });




</script>

{% endblock %}

