{% extends "layout_admin.html" %}
{% from "macros/form.html" import input %}

{% block title %} 영상링크 관리 {% endblock %}
{% block main_section %}

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10">
                <div class="card">

                    <div class="card-header card-header-icon" data-background-color="rose">
                        <i class="material-icons">{{route_kind_id | route_kind_info('icon')}}</i>
                    </div>
                    <div class="card-content">
                        <h4 class="card-title">{{route_kind_id | route_kind_info('name')}} ({{content_title}})
                        </h4>
                        <p class="card-category">
                            눈동자 아이콘의 첫번째는 <span class="text-success"><strong>회원(녹색)</strong></span>, 두번째는 <span class="text-info"><strong>교사(파란색)</strong></span>의 <strong>게시여부</strong>를 가리킵니다. <br />
                            영상링크는 <strong>단일 영상</strong> VIMEO 코드(숫자)만 등록 가능합니다.
                        </p>

                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-group">
                                    {{ input('hidden', 'content_title_id', content_title_id, opt='required') }}
                                    {{ input('text', 'title', opt='required autofocus', placeholder='타이틀 등록') }}
                                </label>
                                <button class="btn btn-primary btn-round btn-fab btn-fab-mini" onclick="titleInsert();" >
                                    <i class="material-icons">add</i>
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="sortable-table" class="table table-striped">
                                <thead class="text-primary">
                              		<tr>
										<th class="text-center" colspan="2" width="10%">ID</th>
										<th class="text-center" width="25%">타이틀</th>
										<th class="text-center" colspan="2" width="25%">영상코드</th>
										<th class="text-center" width="15%">옵션</th>
										<th class="text-center" width="13%">작성자</th>
										<th class="text-center" width="12%">등록일</th>
									</tr>
                                </thead>
                                <tbody>
                                    {% for res in res_list %}
										<tr id="row_{{res.ContentID}}" data-id="{{res.ContentID}}">
                                            <td class="text-left handle" width="3%">
                                                <i class="material-icons">swap_vert</i>
                                            </td>
											<td class="text-center" width="7%">{{res.ContentID}}</td>
											<td class="text-left" width="25%">
                                                <span id="hidden_title_{{res.ContentID}}" style="display: none;">{{res.ListName}}</span>
                                                {{ input('text', 'title_'+(res.ContentID | string), res.ListName) }}
											</td>
											<td class="text-left" width="15%">
                                                <span id="hidden_stream_{{res.ContentID}}" style="display: none;">{{res.StreamID}}</span>
                                                {{ input('number', 'stream_'+(res.ContentID | string), res.StreamID, min=1, max=9999999999) }}
											</td>
                                            <td class="text-center td-actions" width="10%">
                                                <button type="button" onclick="contentUpdate({{res.ContentID}});" class="btn btn-facebook btn-round">
                                                    <i class="material-icons">save</i>
                                                </button>
                                                <button id="play_{{res.ContentID}}" type="button" class="btn btn-warning btn-round js-modal-vimeo" data-video-id="{{res.StreamID}}">
                                                    <i class="material-icons">play_arrow</i>
                                                </button>
                                            </td>
                                            <td class="text-center td-actions" width="15%">
                                                <button id="display_{{res.ContentID}}" type="button" onclick="displayUpdate({{res.ContentID}}, {{0 if res.UseYn else 1}}, 0);" class="btn btn-round {{'btn-success' if res.UseYn}}">
                                                    <i class="material-icons">visibility</i>
                                                </button>
                                                <button id="display_manager_{{res.ContentID}}" type="button" onclick="displayUpdate({{res.ContentID}}, {{0 if res.ManagerUseYn else 1}}, 1);" class="btn btn-round {{'btn-info' if res.ManagerUseYn}}">
                                                    <i class="material-icons">visibility</i>
                                                </button>
                                                <button type="button" onclick="contentDelete({{res.ContentID}});" class="btn btn-round btn-github">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                            </td>
											<td class="text-center" width="13%">{{res.MemberName}}</td>
											<td class="text-center" width="12%">{{res.CreateDate}}</td>
                                        </tr>
									{% else %}
										<tr>
											<td colspan="8" class="text-center">
												<h4>데이터가 존재하지 않습니다.</h4>
											</td>
										</tr>
									{% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-fill btn-github" onclick="javascript:history.back()">뒤로가기</button>
                        <button type="button" class="btn btn-fill btn-success" onclick="changeSorts()">순서저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        //	 $('#sortable-table tbody').sortable();
        $('#sortable-table tbody').sortable({
            handle: '.handle'  // 'handle' 클래스를 드래그 핸들로 지정
        });
    });


    function changeSorts() {
        var ids = [];
        $('#sortable-table tbody tr').each(function() {
          ids.push($(this).data('id'));
        });

        $.ajax({
            type: "POST",
            contentType: 'application/json',
            data: JSON.stringify({ content_ids: ids }),
            url: "/products/admin_content_sort_update",
            success: function (result) {
                site.showNotification('top','center', '순서를 변경하였습니다.', 'info')
            }
        })
    }

    function titleInsert() {
        content_title_id = document.getElementById("content_title_id").value;
        title = document.getElementById("title").value;

        if (title == ""){
            site.showNotification('top','center', '타이틀을 넣어주세요.', 'info')
        } else {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_title_insert",
                data: { content_title_id: content_title_id, title: title },
                success: function (result) {
                    window.location.reload();
                }
            });
        }
    }

    function contentUpdate(content_id) {
        title = document.getElementById("title_" + content_id).value;
        stream_code = document.getElementById("stream_" + content_id).value;
        hidden_title = document.getElementById("hidden_title_" + content_id).innerText;
        hidden_stream_code = document.getElementById("hidden_stream_" + content_id).innerText;

        if (title == hidden_title && stream_code == hidden_stream_code) {
            site.showNotification('top','center', '컨텐츠 정보를 변경해야만 수정이 가능합니다.', 'danger')
        } else {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_update",
                data: { content_id: content_id, title: title, stream_code: stream_code },
                success: function (res) {
                    document.getElementById("hidden_title_" + content_id).innerText = title;
                    document.getElementById("hidden_stream_" + content_id).innerText = stream_code;
                    document.getElementById("stream_" + content_id).setAttribute("value", stream_code);
                    document.getElementById("play_" + content_id).setAttribute("data-video-id", stream_code);
                    site.showNotification('top','center', '정상적으로 수정하였습니다.', 'info')
                }
            });
        }
    }

    function displayUpdate(content_id, display_yn, manager_yn) {
        $.ajax({
            type: "POST",
            url: "/products/admin_content_display_update",
            data: { content_id: content_id, display_yn: display_yn, manager_yn: manager_yn },
            success: function (result) {
                btnElement = document.getElementById("display_" + content_id);
                btnManagerElement = document.getElementById("display_manager_" + content_id);

                if (manager_yn == 1) {
                    if (display_yn === 1) {
                        btnManagerElement.className = 'btn btn-round btn-info';
                        btnManagerElement.setAttribute('onclick', 'displayUpdate(' + content_id + ', 0, 1)');
                    } else {
                        btnManagerElement.className = 'btn btn-round';
                        btnManagerElement.setAttribute('onclick', 'displayUpdate(' + content_id + ', 1, 1)');
                    }
                } else {
                    if (display_yn === 1) {
                        btnElement.className = 'btn btn-round btn-success';
                        btnElement.setAttribute('onclick', 'displayUpdate(' + content_id + ', 0, 0)');
                    } else {
                        btnElement.className = 'btn btn-round';
                        btnElement.setAttribute('onclick', 'displayUpdate(' + content_id + ', 1, 0)');
                    }
                }
            }
        });
    }

   function contentDelete(content_id) {
        swal({
            title: '삭제',
            text: content_id+"번 자료를 정말로 삭제하시겠습니까?",
            type: 'warning',
            showCancelButton: true,
            confirmButtonClass: 'btn btn-success',
            cancelButtonClass: 'btn btn-danger',
            confirmButtonText: 'Yes, delete it!',
            buttonsStyling: false
        }).then(function () {
            $.ajax({
                type: "POST",
                url: "/products/admin_content_delete",
                data: { content_id: content_id },
                success: function (result) {
                    swal({
                        title: '삭제완료!',
                        text: '정상적으로 삭제하였습니다.',
                        type: 'success',
                        confirmButtonClass: "btn btn-success",
                        buttonsStyling: false
                    }),
                        $("#row_" + content_id).remove();
                }
            })
        }).catch(swal.noop);
    }

</script>

{% endblock %}

